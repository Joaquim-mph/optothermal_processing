digraph extractors_slide {
    // Graph attributes for presentation
    graph [
        rankdir=TB
        bgcolor="white"
        fontname="Arial Bold"
        fontsize=32
        label="\n\nHow Metric Extractors Work"
        labelloc=t
        fontsize=42
        dpi=150
        size="16,9!"
        ratio=fill
    ]

    node [fontname="Arial Bold" fontsize=22 penwidth=3]
    edge [fontname="Arial Bold" fontsize=20 penwidth=3]

    // ============================================================
    // TITLE SECTION
    // ============================================================

    subtitle [
        label="Plugin Architecture for Deriving Analytical Results"
        shape=box
        style="filled,rounded"
        fillcolor="#fff9c4"
        color="#f9a825"
        fontsize=24
        penwidth=0
    ]

    // ============================================================
    // 1. INPUT DATA
    // ============================================================

    subgraph cluster_input {
        label="1ï¸âƒ£  INPUT: Measurement Data"
        style=filled
        color="#1976d2"
        fillcolor="#e3f2fd"
        fontsize=28
        penwidth=4

        measurement [
            label="ðŸ“Š Staged Measurement\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nPolars DataFrame\n\nVg (V)    â”‚  I (A)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€\n-1.0      â”‚  1.5e-6\n-0.5      â”‚  0.8e-6\n 0.0      â”‚  0.5e-6  â† CNP!\n 0.5      â”‚  0.9e-6\n 1.0      â”‚  1.6e-6"
            shape=box
            style="filled,rounded"
            fillcolor="#bbdefb"
            color="#1976d2"
            fontsize=20
            height=3
            width=5
        ]

        metadata [
            label="ðŸ“‹ Metadata\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nchip_number: 67\nproc: IVg\nvds_v: 0.1\nrun_id: a1b2c3..."
            shape=note
            style=filled
            fillcolor="#c5cae9"
            color="#3f51b5"
            fontsize=18
            width=4
        ]
    }

    // ============================================================
    // 2. EXTRACTOR SELECTION
    // ============================================================

    subgraph cluster_selection {
        label="2ï¸âƒ£  EXTRACTOR SELECTION"
        style=filled
        color="#388e3c"
        fillcolor="#e8f5e9"
        fontsize=28
        penwidth=4

        procedure_check [
            label="ðŸ” Check Procedure Type\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nproc = \"IVg\""
            shape=diamond
            style=filled
            fillcolor="#c8e6c9"
            color="#388e3c"
            fontsize=20
            width=4
        ]

        extractor_map [
            label="ðŸ“š Extractor Registry\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nIVg   â†’ CNPExtractor\nVVg   â†’ CNPExtractor\nIt    â†’ PhotoresponseExtractor\nVt    â†’ PhotoresponseExtractor\nITt   â†’ PhotoresponseExtractor"
            shape=box
            style=filled
            fillcolor="#a5d6a7"
            color="#2e7d32"
            fontsize=18
            width=6
            height=2.5
        ]
    }

    // ============================================================
    // 3. EXTRACTOR LOGIC
    // ============================================================

    subgraph cluster_extraction {
        label="3ï¸âƒ£  EXTRACTION LOGIC"
        style=filled
        color="#7b1fa2"
        fillcolor="#f3e5f5"
        fontsize=28
        penwidth=4

        extractor [
            label="âš™ï¸  CNPExtractor.extract()\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n1ï¸âƒ£  Calculate Resistance\n   R = Vds / I\n\n2ï¸âƒ£  Find Peak\n   CNP = Vg where R is max\n\n3ï¸âƒ£  Compute Confidence\n   Check: edge? noisy?\n\n4ï¸âƒ£  Return DerivedMetric"
            shape=box
            style="filled,rounded"
            fillcolor="#ce93d8"
            color="#7b1fa2"
            fontsize=20
            height=4
            width=6
        ]

        code_example [
            label="ðŸ’» Code Snippet\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nclass CNPExtractor:\n  applicable_procedures =\n    [\"IVg\", \"VVg\"]\n\n  def extract(measurement, metadata):\n    # Calculate resistance\n    r = abs(vds / current)\n    \n    # Find max resistance point\n    cnp_idx = argmax(r)\n    cnp_voltage = vg[cnp_idx]\n    \n    return DerivedMetric(\n      metric_name=\"cnp_voltage\",\n      value_float=cnp_voltage,\n      ...)"
            shape=note
            style=filled
            fillcolor="#e1bee7"
            color="#8e24aa"
            fontsize=16
            width=6
            height=4
        ]
    }

    // ============================================================
    // 4. OUTPUT
    // ============================================================

    subgraph cluster_output {
        label="4ï¸âƒ£  OUTPUT: Derived Metric"
        style=filled
        color="#c2185b"
        fillcolor="#fce4ec"
        fontsize=28
        penwidth=4

        derived_metric [
            label="âœ¨ DerivedMetric\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nrun_id: a1b2c3...\nchip_number: 67\nproc: IVg\nseq_num: 15\n\nmetric_name: cnp_voltage\nvalue_float: -0.35\nunit: V\n\nconfidence: 1.0\nflags: null\n\nextraction_method:\n  peak_resistance\nextraction_version:\n  v3.0+g1a2b3c"
            shape=box
            style="filled,rounded"
            fillcolor="#f8bbd0"
            color="#c2185b"
            fontsize=18
            height=4
            width=5
        ]

        saved [
            label="ðŸ’¾ Saved to:\nmetrics.parquet"
            shape=cylinder
            style=filled
            fillcolor="#f48fb1"
            color="#ad1457"
            fontsize=20
            width=3
            height=1.5
        ]
    }

    // ============================================================
    // DATA FLOW
    // ============================================================

    subtitle -> measurement [style=invis]

    measurement -> procedure_check [label="  proc=\"IVg\"" fontsize=20 penwidth=4 color="#388e3c"]
    metadata -> procedure_check [style=dashed penwidth=3 color="#3f51b5"]

    procedure_check -> extractor_map [label="  lookup" fontsize=20 penwidth=4 color="#388e3c"]

    extractor_map -> extractor [label="  CNPExtractor" fontsize=20 penwidth=4 color="#7b1fa2"]

    extractor -> derived_metric [label="  compute" fontsize=20 penwidth=4 color="#c2185b"]

    derived_metric -> saved [label="  write" fontsize=20 penwidth=4 color="#c2185b"]

    // Side connection for code example
    extractor -> code_example [style=dashed penwidth=2 color="#8e24aa" constraint=false]

    // ============================================================
    // KEY FEATURES BOX
    // ============================================================

    features [
        label="ðŸŽ¯ KEY FEATURES\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâœ… Plugin-based: Add extractors without\n   changing pipeline\n\nâœ… Parallel: Process 6 measurements\n   simultaneously\n\nâœ… Quality-aware: Confidence scores\n   and warning flags\n\nâœ… Provenance: Track extraction method\n   and code version\n\nâœ… Type-safe: Pydantic models ensure\n   schema consistency"
        shape=box
        style="filled,rounded"
        fillcolor="#dcedc8"
        color="#689f38"
        fontsize=18
        penwidth=4
        width=6
        height=3
    ]

    saved -> features [style=invis]

    // ============================================================
    // AVAILABLE EXTRACTORS
    // ============================================================

    available [
        label="ðŸ“¦ AVAILABLE EXTRACTORS\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nðŸ”¹ CNPExtractor\n   Procedures: IVg, VVg\n   Extracts: Charge neutrality point voltage\n\nðŸ”¹ PhotoresponseExtractor\n   Procedures: It, Vt, ITt\n   Extracts: Î”I_ds, Î”V_ds, responsivity\n\nðŸ”¹ CalibrationMatcher\n   Procedures: LaserCalibration\n   Extracts: Irradiated power\n\nâž• Easy to add more!"
        shape=note
        style="filled,rounded"
        fillcolor="#fff9c4"
        color="#f9a825"
        fontsize=18
        penwidth=3
        width=6
        height=3
    ]

    {rank=same; features; available}
    features -> available [style=invis]
}
